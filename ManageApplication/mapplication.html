<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage My WFH Applications</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.21.2/dist/bootstrap-vue.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
  <link href="mapplication.css" rel="stylesheet" />

</head>

<body>
  <div id="app" class="container mt-5">
    <div class="form-container">
      <h2 class="text-center mb-4">{{ pageTitle }}</h2>

      <!-- View Indicator - colour so we know what mode we are on -->
      <div class="mb-3">
        <div :class="['view-indicator', isManagerView ? 'manager-view' : 'my-view']"></div>
      </div>

      <!-- Switcher Button between Manager & My View Mode -->
      <div class="text-end mb-3">
        <b-button v-if="role !==2" @click="toggleView" class="btn btn-info">
          {{ isManagerView ? 'Switch to My View' : 'Switch to Manager View' }}
        </b-button>
      </div>

      <!-- Tabs for Approved, Pending, and Rejected Applications -->
      <b-nav tabs class="mb-4">
        <b-nav-item :active="activeTab === 'approved'" @click="setTab('approved')" class="nav-item">{{ isManagerView ?
          'Team Approved Applications' : 'My Approved Applications' }}</b-nav-item>
        <b-nav-item :active="activeTab === 'pending'" @click="setTab('pending')" class="nav-item">{{ isManagerView ?
          'Team Pending Applications' : 'My Pending Applications' }}</b-nav-item>
        <b-nav-item :active="activeTab === 'rejected'" @click="setTab('rejected')" class="nav-item">{{ isManagerView ?
          'Team Rejected Applications' : 'My Rejected Applications' }}</b-nav-item>
      </b-nav>

      <!-- Card for Team Statistics that can be pulled (Only shown in Team View and Pending Applications tab) -->
      <b-card v-if="isManagerView && activeTab === 'pending'" class="mb-4">
        <b-card-header>Select Date for Team Statistics</b-card-header>
        <b-card-body>
          <b-form-group label="Choose a date:">
            <b-datepicker v-model="selectedDate" class="mb-3" @input="updateStats"></b-datepicker>
          </b-form-group>

          <div class="mb-2">
            <strong>Total Number Personnel In Team:</strong> {{ totalNumberInTeam }}
          </div>
          <div class="mb-2">
            <strong>Total Number of Team Members in Office:</strong> {{ totalInOffice }}
          </div>
          <div class="mb-2">
            <strong>Total Number of Team Members WFH:</strong> {{ totalWFH }}
          </div>
          <div>
            <strong>% of Team Members WFH:</strong> {{ percentageWFH }}%
          </div>
        </b-card-body>
      </b-card>

      <!-- Card for Pending Applications both My Own/Manager View -->
      <b-card v-if="activeTab === 'pending'" class="card mb-4">
        <b-card-header :class="{'bg-danger text-white': isManagerView}">
          {{ isManagerView ? 'Team Pending Applications' : 'My Pending Applications' }}
        </b-card-header>
        <b-card-body>
          <b-table v-if="!isManagerView" :items="ownApplications['Pending']" :fields="pendingFields" responsive="sm">
            <template v-slot:cell(Withdraw)="data">
              <b-button variant="danger" @click="withdraw(data.item)">Withdraw</b-button>
            </template>
          </b-table>
          <div v-else>
            <b-table :items="teamApplications['Pending']" :fields="fieldsr" responsive="sm">
              <!-- Changing the decision from 'decision' to "Decision" to try -->
              <template v-slot:cell(Decision)="data">
                <b-button variant="success" @click="approve(data.item)">Approve</b-button>
                <!-- If they reject, it'll prompt openRejectionModal take note because we want the reason so a text box comes out :> -->
                <b-button variant="danger" @click="openRejectionModal(data.item)">Reject</b-button>
              </template>
            </b-table>
          </div>
        </b-card-body>
      </b-card>

      <!-- Cards for Approved Applications both My Own/Manager View -->
      <b-card v-if="activeTab === 'approved'" class="card mb-4">
        <b-card-header :class="{'bg-danger text-white': isManagerView}">
          {{ isManagerView ? 'Team Approved Applications' : 'My Approved Applications' }}
        </b-card-header>
        <b-card-body>
          <b-table v-if="!isManagerView" :items="ownApplications['Approved']" :fields="fields" responsive="sm">
            <template v-slot:cell(Withdraw)="data">
              <b-button variant="danger" @click="withdraw(data.item)">Withdraw</b-button>
            </template>
          </b-table>
          <div v-else>
            <b-table :items="teamApplications['Approved']" :fields="fields" responsive="sm">
              <template v-slot:cell(Withdraw)="data">
              <b-button variant="danger" @click="withdraw(data.item)">Withdraw</b-button>
            </template>
            </b-table>
          </div>
        </b-card-body>
      </b-card>

      <!-- Card for Rejected Applications both My Own/Manager View -->
      <b-card v-if="activeTab === 'rejected'" class="card mb-4">
        <b-card-header :class="{'bg-danger text-white': isManagerView}">
          {{ isManagerView ? 'Team Rejected Applications' : 'My Rejected Applications' }}
        </b-card-header>
        <b-card-body>
          <b-table v-if="!isManagerView" :items="ownApplications['Rejected']" :fields="fieldsr" responsive="sm"></b-table>
          <div v-else>
            <b-table :items="teamApplications['Rejected']" :fields="fieldsr" responsive="sm">
            </b-table>
          </div>
        </b-card-body>
      </b-card>

      <!-- Manager View -> Reject a pending application prompts the text box -->
      <div v-if="showRejectionModal" class="modal fade show d-block" tabindex="-1" role="dialog"
        style="display: block;">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Provide Rejection Reason</h5>
              <button type="button" class="close" @click="closeRejectionModal">
                <span>&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <textarea v-model="rejectionReason" class="form-control" rows="3" maxlength="250"
                placeholder="Enter your rejection reason (max 250 characters)"></textarea>
              <small>{{ rejectionReason.length }} / 250</small>
            </div>
            <div class="modal-footer">
              <b-button variant="secondary" @click="closeRejectionModal">Close</b-button>
              <b-button variant="primary" @click="submitRejection">Submit</b-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Back to Home Page Button -->
      <div class="text-center mt-4">
        <b-button variant="primary" class="btn-primary" @click="goBack">
          Go Back to Home Page
        </b-button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.21.2/dist/bootstrap-vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    new Vue({
      el: "#app",
      data: {
        staffID: localStorage.getItem('staffID'),
        manager: localStorage.getItem('Reporting_Manager'),
        role: 2,
        teamData: null,
        dataArr: null,
        isManagerView: false, // used to toggle between views
        activeTab: "approved",
        ApplicationArr: [],
        teamApplications: {'Approved':[],'Pending':[],'Rejected':[]},
        ownApplications: {'Approved':[],'Pending':[],'Rejected':[]},
        dateSortedApproved:{},

        fields: [ 
          { key: "Staff_ID", label: "Staff ID" },
          { key: "Staff_Name", label: "Staff Name" },
          { key: "Date_Applied", label: "Date Applied" },
          { key: "Time_Of_Day", label: "Time of Day" },
          { key: "Status_Of_Application", label: "Status" },
          { key: "Reason", label: "Reason" },
          { key: "Decision", label: "Decision" },
          { key: "Withdraw", label: "Withdraw" }, 
        ],
        fieldsr: [  
          { key: "Staff_ID", label: "Staff ID" },
          { key: "Staff_Name", label: "Staff Name" },
          { key: "Date_Applied", label: "Date Applied" },
          { key: "Time_Of_Day", label: "Time of Day" },
          { key: "Status_Of_Application", label: "Status" },
          { key: "Reason", label: "Reason" },
          { key: "Decision", label: "Decision" },
        ],
        pendingFields: [
          { key: "Staff_ID", label: "Staff ID" },
          { key: "Staff_Name", label: "Staff Name" },
          { key: "Date_Applied", label: "Date Applied" },
          { key: "Time_Of_Day", label: "Time of Day" },
          { key: "Status_Of_Application", label: "Status" },
          { key: "Reason", label: "Reason" },
          { key: "Withdraw", label: "Withdraw" },
        ],
        tempApproveCount: {},
        // Below 3 for rejectionmodel 
        showRejectionModal: false,
        rejectionReason: '',
        selectedItem: null,
        selectedDate: null,
        totalNumberInTeam: '', 
        totalInOffice: '', 
        totalWFH: '', 
      },
      computed: {
        percentageWFH() {
          return ((this.totalWFH / this.totalNumberInTeam) * 100).toFixed(2);
        },
        pageTitle() {
          return this.isManagerView ? 'Manage Team WFH Applications' : 'Manage My WFH Applications';
        },
      },

      async mounted() {
        try{
          await this.getrole()
        
        this.getOwnApplications()
        this.getteam()
        this.getTeamApplications()
      }catch (error){
        console.error('Error during mounted execution',error)
      }},

      methods: {

        findId(id, arr) {
          for (let i = 0; i < arr.length; i++) {
            if (id == arr[i][0]) {
              return i;
            }
          }
          return 0;
        },

        async getrole() {
          try {
            const response = await fetch("http://localhost:5000/employee");
            const returnedJSON = await response.json();
            console.log(returnedJSON);

            this.dataArr = returnedJSON.data;

            const staffInd = this.findId(this.staffID, this.dataArr);

            this.role = this.dataArr[staffInd][8];

            console.log(this.role);
          } catch (error) {
            console.error("Error fetching data:", error);
            this.isLoading = false;
          }
        },


        async getteam() {
          const team = await axios.post('http://localhost:5000/findTeam/' + this.staffID)
          var teamResult = team.data.employees
          this.teamData = teamResult
          console.log(this.teamData)
          resLen = Object.keys(this.teamData).length
          if (resLen > 1) {
            this.totalNumberInTeam = resLen
          } else {
            for (const [key,value] of Object.entries(this.teamData)) {
              this.totalNumberInTeam = value.length
            }
          }
        },
        async getTeamApplications() {
          try {
            var response = await axios.post('http://localhost:5001/getTeamApplications', {
              staffID: this.staffID  // send staffID in the request body as JSON
            });
            
            
            if (response.data.status === 'success') {
              console.log(response.data.Applications);  // Log the actual pending applications
              // Optionally, store the result in a data property for further use
              // this.TeampendingApplications = response.data.pendingApplications;

              // Try to see if there is a need to clear the array first
              var apps = response.data.Applications
              for (entry of apps) {
                const staffID = entry[0]
                const staffInd = this.findId(staffID, this.dataArr)
                const startDate = entry[1]
                this.teamApplications[entry[3]].push({
                  Staff_ID: staffID,
                  Staff_Name: this.dataArr[staffInd][1] + ' ' + this.dataArr[staffInd][2],
                  Date_Applied: startDate,
                  Time_Of_Day: entry[2],
                  Status_Of_Application: entry[3],
                  Reason: entry[4],
                  Decision: entry[5]
                })
                if (entry[3] == 'Approved') {
                  if (!this.tempApproveCount[startDate]) {
                    this.tempApproveCount[startDate] = {}
                  }

                  if (!this.tempApproveCount[startDate][staffID]) {
                    this.tempApproveCount[startDate][staffID] = 1
                  }

                  for (const [key,value] of Object.entries(this.tempApproveCount)) {
                    this.dateSortedApproved[key] = Object.keys(value).length
                  }
                  console.log(this.dateSortedApproved)
                }
              }
              console.log(this.teamApplications)

            } else {
              console.error('Error:', response.data.message);
            }
          } catch (error) {
            console.error('API call failed:', error);
          }
        },

        getOwnApplications() {
          this.staffID = localStorage.getItem('staffID');
          fetch('http://localhost:5000/employee')
            .then(response => response.json())
            .then(returnedJSON => {
              dataArr = returnedJSON.data;

              staffInd = this.findId(this.staffID, dataArr);

              fetch('http://localhost:5001/application')
                .then(response => response.json())
                .then(returnedJSON => {
                  this.ApplicationArr = returnedJSON.data;
                  console.log(this.ApplicationArr)

                  for (entry of this.ApplicationArr) {
                    if (entry[0] == this.staffID) {
                      const staffInd = this.findId(this.staffID, this.dataArr);

                      this.ownApplications[entry[4]].push({
                        Staff_ID: this.staffID,
                        Staff_Name: this.dataArr[staffInd][1] + ' ' + this.dataArr[staffInd][2],
                        Date_Applied: entry[1],
                        Time_Of_Day: entry[2],
                        Status_Of_Application: entry[4],
                        Reason: entry[5],
                        Decision: 'No Issue'
                      })
                    }
                  }
                });
            })
            .catch(error => console.error('Error fetching data:', error));
        },
        updateStats() {
          console.log('updating...')
          if (this.dateSortedApproved[this.selectedDate]) {
            this.totalWFH = this.dateSortedApproved[this.selectedDate]
            this.totalInOffice = this.totalNumberInTeam - this.totalWFH
            // this.percentageWFH = (this.totalWFH/this.totalInOffice).toFixed(2)
          } else {
            this.totalWFH = 0
            this.totalInOffice = this.totalNumberInTeam
          }
        },

        toggleView() {
          if (this.role == '2') {
            this.isManagerView = False
          }
          else {
            this.isManagerView = !this.isManagerView
          }
        },
        setTab(tab) {
          this.activeTab = tab;
        },
        goBack() {
          window.location.href = "../Home/home.html"
        },
        async approve(item) {
          // Use this to manage the approval of pending requests, prolly is sql here?
          try {
            if (this.tempApproveCount[item.Date_Applied]) {
              if (!(item.Staff_ID in this.tempApproveCount[item.Date_Applied])) {
                var percentWFH = (this.dateSortedApproved[item.Date_Applied]+1)/this.totalNumberInTeam
                if (percentWFH > 0.5) {
                  alert("Quota exceeded")
                  return
                }
              }
            }
            console.log(item.Staff_ID, item.Date_Applied, item.Time_Of_Day)
            const response = await axios.post('http://localhost:5001/approveApplication', {
              Staff_ID: item.Staff_ID,
              Date_Applied: item.Date_Applied,
              Time_Of_Day: item.Time_Of_Day,
            });
            if (response.data.status === 'success') {
              // Remove the approved application from the pending list
              this.teamApplications['Pending'] = this.teamApplications['Pending'].filter(
                app => !(app.Staff_ID === item.Staff_ID && app.Date_Applied === item.Date_Applied && app.Time_Of_Day === item.Time_Of_Day)
              );
              // Optionally, add it to the approved applications list
              this.teamApplications['Approved'].push({
                ...item,
                Status_Of_Application: 'Approved',
                Decision: 'No Issue'
              });
            } else {
              console.error('Error:', response.data.message);
              alert('Failed to approve application: ' + response.data.message);
            }
          } catch (error) {
            console.error('API call failed:', error);
            alert('An error occurred while approving the application.');
          }

        },
        openRejectionModal(item) {
          this.showRejectionModal = true;  // If manager reject, this leads to the pop out
          this.selectedItem = item;
        },
        closeRejectionModal() {
          this.showRejectionModal = false;
          this.rejectionReason = '';
          // Set it back to default
          this.selectedItem = null;
        },
        async submitRejection() {
          // Logic for submitting rejection reason -> this one will manage the rejection of pending requests, prolly is sql here also?
          try {
            const response = await axios.post('http://localhost:5001/rejectApplication', {
              Staff_ID: this.selectedItem.Staff_ID,
              Date_Applied: this.selectedItem.Date_Applied,
              Time_Of_Day: this.selectedItem.Time_Of_Day,
              Rejection_Reason: this.rejectionReason,
            });
            if (response.data.status === 'success') {
              // Remove the rejected application from the pending list
              this.teamApplications['Pending'] = this.teamApplications['Pending'].filter(
                app => !(app.Staff_ID === this.selectedItem.Staff_ID && app.Date_Applied === this.selectedItem.Date_Applied && app.Time_Of_Day === this.selectedItem.Time_Of_Day)
              );
              // Add it to the rejected applications list
              this.teamApplications['Rejected'].push({
                ...this.selectedItem,
                Status_Of_Application: 'Rejected',
                Decision: this.rejectionReason, // Set the rejection reason
              });
              // Close the modal
              this.closeRejectionModal();
            } else {
              console.error('Error:', response.data.message);
              alert('Failed to reject application: ' + response.data.message);
            }
          } catch (error) {
            console.error('API call failed:', error);
            alert('An error occurred while rejecting the application.');
          }
          this.closeRejectionModal();
        },

        findstaffid(item){
          fetch('http://localhost:5000/employee')
            .then(response => response.json())
            .then(returnedJSON => {
              dataArr = returnedJSON.data;
              staffInd = this.findId(firstname, dataArr);
            })
            .catch(error => console.error('Error fetching data:', error));
        },

        async withdraw(item){
          // TO BE DONE xd
          console.log(item)
          if (item.Status_Of_Application=='Pending'){
            try {
              const response = await axios.post('http://localhost:5001/withdrawPendingApplication', {
                Staff_ID: item.Staff_ID,
                Date_Applied: item.Date_Applied,
                Time_Of_Day: item.Time_Of_Day,
                Reason: item.Reason,
              });
              console.log(response)
              if (response.data.status === 'success') {
                this.ownApplications['Pending'] = this.ownApplications['Pending'].filter(
                app => !(app.Staff_ID === item.Staff_ID && app.Date_Applied === item.Date_Applied && app.Time_Of_Day === item.Time_Of_Day)
              );
                alert('Application withdrawn successfully.');
              } else {
                alert('Failed to withdraw the application.');
              }
            } catch (error) {
              console.error('Error during withdrawal:', error);
              alert('An error occurred while trying to withdraw the application.');
            }
          

          }
        }
      },



    });
  </script>
</body>

</html>