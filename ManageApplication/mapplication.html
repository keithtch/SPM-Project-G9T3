<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage My WFH Applications</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.21.2/dist/bootstrap-vue.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
  <link href="mapplication.css" rel="stylesheet" />
</head>

<body>
  <div id="app" class="container mt-5">
    <div class="form-container">
      <h2 class="text-center mb-4">{{ pageTitle }}</h2>

      <!-- View Indicator -->
      <div class="mb-3">
        <div :class="['view-indicator', isManagerView ? 'manager-view' : 'my-view']"></div>
      </div>


      <div class="text-end mb-3">
        <b-button v-if="role !== 2" @click="toggleView" class="btn btn-info">
          {{ isManagerView ? 'Switch to My View' : 'Switch to Manager View' }}
        </b-button>
      </div>

      <!-- Switcher Button between Manager & My View Mode -->
      <div class="mb-4">
        <b-card v-if="isManagerView">
          <b-form-group label="Filter by date:">
            <b-datepicker v-model="filteredDate" class="mb-3" @input="filterDates('')"></b-datepicker>
          </b-form-group>
          <b-button variant="success" @click="filterDates('all')">View All</b-button>
        </b-card>
      </div>

      <!-- Tabs for Approved, Pending, and Rejected Applications -->
      <b-nav tabs class="mb-4">
        <b-nav-item :active="activeTab === 'approved'" @click="setTab('approved')" class="nav-item">
          {{ isManagerView ? 'Team Approved Applications' : 'My Approved Applications' }}
        </b-nav-item>
        <b-nav-item :active="activeTab === 'pending'" @click="setTab('pending')" class="nav-item">
          {{ isManagerView ? 'Team Pending Applications' : 'My Pending Applications' }}
        </b-nav-item>
        <b-nav-item :active="activeTab === 'rejected'" @click="setTab('rejected')" class="nav-item">
          {{ isManagerView ? 'Team Rejected Applications' : 'My Rejected Applications' }}
        </b-nav-item>
        <b-nav-item v-if="isManagerView" :active="activeTab === 'pending_withdrawal'" @click="setTab('pending_withdrawal')" class="nav-item">
          Team Pending Withdrawal Applications
        </b-nav-item>
      </b-nav>

      <!-- Team Statistics Card -->
      <b-card v-if="isManagerView && activeTab === 'pending'" class="mb-4">
        <b-card-header>Select Date for Team Statistics</b-card-header>
        <b-card-body>
          <b-form-group label="Choose a date:">
            <b-datepicker v-model="selectedDate" class="mb-3" @input="updateStats"></b-datepicker>
          </b-form-group>
          <div class="mb-2"><strong>Total Number Personnel In Team:</strong> {{ totalNumberInTeam }}</div>
          <div class="mb-2"><strong>Total Number of Team Members in Office:</strong> {{ totalInOffice }}</div>
          <div class="mb-2"><strong>Total Number of Team Members WFH:</strong> {{ totalWFH }}</div>
          <div><strong>% of Team Members WFH:</strong> {{ percentageWFH }}%</div>
        </b-card-body>
      </b-card>

      <!-- Pending Applications Card -->
      <b-card v-if="activeTab === 'pending'" class="card mb-4">
        <b-card-header :class="{'bg-danger text-white': isManagerView}">
          {{ isManagerView ? 'Team Pending Applications' : 'My Pending Applications' }}
        </b-card-header>
        <b-card-body>
          <b-table v-if="!isManagerView" :items="ownApplications['Pending']" :fields="pendingFields" responsive="sm">
            <template v-slot:cell(Withdraw)="data">
              <b-button variant="danger" @click="withdraw(data.item)">Withdraw</b-button>
            </template>
          </b-table>
          <div v-else>
            <b-table :items="teamApplications['Pending']" :fields="fieldsr" responsive="sm">
              <template v-slot:cell(Decision)="data">
                <b-button variant="success" @click="approve(data.item)">Approve</b-button>
                <b-button variant="danger" @click="openRejectionModal(data.item)">Reject</b-button>
              </template>
            </b-table>
          </div>
        </b-card-body>
      </b-card>

    <!-- Approved Applications Card -->
    <b-card v-if="activeTab === 'approved'" class="card mb-4">
      <b-card-header :class="{'bg-danger text-white': isManagerView}">
        {{ isManagerView ? 'Team Approved Applications' : 'My Approved Applications' }}
      </b-card-header>
      <b-card-body>
        <b-table v-if="!isManagerView" :items="ownApplications['Approved']" :fields="fields" responsive="sm">
          <template v-slot:cell(Withdraw)="data">
            <b-button :disabled="!data.item.withdrawable" variant="danger" @click="withdraw(data.item)">Withdraw</b-button>
          </template>
          <template v-slot:cell(Change)="data">
            <b-button :disabled="!data.item.withdrawable" variant="warning" @click="openChangeModal(data.item)">Change</b-button>
          </template>
        </b-table>
        <div v-else>
          <b-table :items="teamApplications['Approved']" :fields="fields" responsive="sm">
            <template v-slot:cell(Withdraw)="data">
              <b-button variant="danger" @click="withdraw(data.item)">Withdraw</b-button>
            </template>
          </b-table>
        </div>
      </b-card-body>
    </b-card>

    <!-- Change Application Modal -->
    <div v-if="showChangeModal" class="modal fade show d-block" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Change Application Date</h5>
            <button type="button" class="close" @click="closeChangeModal">
              <span>&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Fixed Period Application -->
            <div class="transition-fade fade-in">
              <b-form-group label="Select New Date" class="form-group">
                <div class="row">
                  <div class="col-12">
                    <b-form-datepicker
                      v-model="changeDate"
                      :today="currentDate"
                      :min="minDate"
                      :max="maxDate"
                      placeholder="Select date"
                      class="mb-3 w-100"
                    ></b-form-datepicker>
                  </div>
                </div>
              </b-form-group>

              <!-- Reason textbox -->
              <b-form-group label="Reason for Change">
                <b-form-textarea
                  v-model="changeReason"
                  placeholder="Enter reason for change"
                  rows="3"
                  max-rows="3"
                  :maxlength="50"
                  class="w-100"
                ></b-form-textarea>
                <small class="text-muted">{{ changeReason ? changeReason.length : 0 }}/50 characters</small>
              </b-form-group>
            </div>
          </div>
          <div class="modal-footer">
            <b-button variant="secondary" @click="closeChangeModal">Close</b-button>
            <b-button variant="primary" @click="submitChange" :disabled="!isChangeValid">Submit Change</b-button>
          </div>
        </div>
      </div>
    </div>


      <!-- Pending Withdrawal Applications Card (Manager View) -->
      <b-card v-if="activeTab === 'pending_withdrawal' && isManagerView" class="card mb-4">
        <b-card-header class="bg-danger text-white">Team Pending Withdrawal Applications</b-card-header>
        <b-card-body>
          <b-table :items="teamApplications['Pending_Withdrawal']" :fields="fieldspw" responsive="sm">
            <template v-slot:cell(Decision)="data">
              <b-button variant="success" @click="ApprovePendingSubmitWithdrawal(data.item)">Approve</b-button>
              <b-button variant="danger" @click="openRejectionModal(data.item)">Reject</b-button>
            </template>
          </b-table>
        </b-card-body>
      </b-card>

      <!-- Rejected Applications Card -->
      <b-card v-if="activeTab === 'rejected'" class="card mb-4">
        <b-card-header :class="{'bg-danger text-white': isManagerView}">
          {{ isManagerView ? 'Team Rejected Applications' : 'My Rejected Applications' }}
        </b-card-header>
        <b-card-body>
          <b-table v-if="!isManagerView" :items="ownApplications['Rejected']" :fields="fieldsr" responsive="sm"></b-table>
          <div v-else>
            <b-table :items="teamApplications['Rejected']" :fields="fieldsr" responsive="sm"></b-table>
          </div>
        </b-card-body>
      </b-card>

      <!-- Withdrawal Modal -->
      <div v-if="showWithdrawalModal" class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Provide Withdrawal Reason</h5>
              <button type="button" class="close" @click="closeWithdrawalModal">
                <span>&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <textarea v-model="withdrawalReason" class="form-control" rows="3" maxlength="250"
                placeholder="Enter your withdrawal reason (max 250 characters)"></textarea>
              <small>{{ withdrawalReason.length }} / 250</small>
            </div>
            <div class="modal-footer">
              <b-button variant="secondary" @click="closeWithdrawalModal">Close</b-button>
              <b-button v-if="isManagerView" variant="primary" @click="submitWithdrawal">Submit</b-button>
              <b-button v-if="!isManagerView" variant="primary" @click="pendingsubmitWithdrawal">Submit</b-button>
            </div>
          </div>
        </div>
      </div>

      <!-- Rejection Modal -->
      <div v-if="showRejectionModal" class="modal fade show d-block" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Provide Rejection Reason</h5>
              <button type="button" class="close" @click="closeRejectionModal">
                <span>&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <textarea v-model="rejectionReason" class="form-control" rows="3" maxlength="250"
                placeholder="Enter your rejection reason (max 250 characters)"></textarea>
              <small>{{ rejectionReason.length }} / 250</small>
            </div>
            <div class="modal-footer">
              <b-button variant="secondary" @click="closeRejectionModal">Close</b-button>
              <b-button v-if="activeTab === 'pending'" variant="primary" @click="submitRejection">Submit</b-button>
              <b-button v-if="activeTab === 'pending_withdrawal'"variant="primary" @click="RejectPendingSubmitWithdrawal">Submit</b-button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="text-center mb-4">
      <button class="btn btn-primary mt-5" @click="goBack">
          Go Back to Home Page
      </button>
  </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.21.2/dist/bootstrap-vue.min.js"></script>
</body>

</html>


  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.21.2/dist/bootstrap-vue.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    new Vue({
      el: "#app",
      data: {
        staffID: localStorage.getItem('staffID'),
        manager: localStorage.getItem('Reporting_Manager'),
        role: 2,
        teamData: null,
        dataArr: null,
        isManagerView: false, // used to toggle between views
        activeTab: "approved",
        ApplicationArr: [],
        teamApplications: { 'Approved': [], 'Pending': [], 'Rejected': [], 'Pending_Withdrawal': [] },
        ownApplications: { 'Approved': [], 'Pending': [], 'Rejected': [], 'Pending_Withdrawal': []  },
        appsCopy: null,
        dateSortedApproved: {},
        // Jing Hang withdrawal modal
        showWithdrawalModal: false,  // Controls whether the modal is visible
        withdrawalReason: '',        // Holds the reason for withdrawal
        selectedItem: null,          // Stores the application item to be withdrawn
        fixedDateArray: [], //@ZIMING EVERYTHING BELOW HERE VUE DATA IS NEW FOR CHANGE FUNCTION
        fixedDateOptions: {},
        showChangeModal: false,
        applicationType: 'fixed',
        recurringDays: [],
        dayOptions: {},
        recurringStartDate: '',
        recurringEndDate: '',
        changeDate: '',
        changeReason: '',
        endDate: '',
        currentDate: new Date().toISOString().split('T')[0],
        minDate: new Date().toISOString().split('T')[0],
        maxDate: new Date(Date.now() + (30 * 24 * 60 * 60 * 1000)).toISOString().split('T')[0],
        daysOfWeek: [
          { text: 'Monday', value: '1' },
          { text: 'Tuesday', value: '2' },
          { text: 'Wednesday', value: '3' },
          { text: 'Thursday', value: '4' },
          { text: 'Friday', value: '5' }
        ],
        timeOptions: [
          { value: 'AM', text: 'AM' },
          { value: 'PM', text: 'PM' },
          { value: 'FULL', text: 'Full Day' }
        ],
        // @ZIMING UPDATED CHANGE
        fields: [
          { key: "Staff_ID", label: "Staff ID" },
          { key: "Staff_Name", label: "Staff Name" },
          { key: "Date_Applied", label: "Date Applied" },
          { key: "Time_Of_Day", label: "Time of Day" },
          { key: "Status_Of_Application", label: "Status" },
          { key: "Reason", label: "Reason" },
          { key: "Decision", label: "Decision" },
          { key: "Withdraw", label: "Withdraw" },
          { key: "Change", label: "Change" }
        ],
        fieldsr: [
          { key: "Staff_ID", label: "Staff ID" },
          { key: "Staff_Name", label: "Staff Name" },
          { key: "Date_Applied", label: "Date Applied" },
          { key: "Time_Of_Day", label: "Time of Day" },
          { key: "Status_Of_Application", label: "Status" },
          { key: "Reason", label: "Reason" },
          { key: "Decision", label: "Decision" },
        ],
        fieldspw: [
          { key: "Staff_ID", label: "Staff ID" },
          { key: "Staff_Name", label: "Staff Name" },
          { key: "Date_Applied", label: "Date Applied" },
          { key: "Time_Of_Day", label: "Time of Day" },
          { key: "Status_Of_Application", label: "Status" },
          { key: "Withdraw_Reason", label: "Withdraw Reason" },
          { key: "Decision", label: "Decision" },
        ],
        pendingFields: [
          { key: "Staff_ID", label: "Staff ID" },
          { key: "Staff_Name", label: "Staff Name" },
          { key: "Date_Applied", label: "Date Applied" },
          { key: "Time_Of_Day", label: "Time of Day" },
          { key: "Status_Of_Application", label: "Status" },
          { key: "Reason", label: "Reason" },
          { key: "Withdraw", label: "Withdraw" },
        ],
        tempApproveCount: {},
        // Below 3 for rejectionmodel 
        showRejectionModal: false,
        rejectionReason: '',
        selectedItem: null,
        selectedDate: null,
        totalNumberInTeam: '',
        totalInOffice: '',
        totalWFH: '',
        withdrawalReason: null,
        filteredDate: '',
        teamRecurringIDs: {},
        ownRecurringIDs: {},
      },
      computed: {
        percentageWFH() {
          return ((this.totalWFH / this.totalNumberInTeam) * 100).toFixed(2);
        },
        pageTitle() {
          return this.isManagerView ? 'Manage Team WFH Applications' : 'Manage My WFH Applications';
        },
        isChangeValid() {
          return this.changeDate && 
                this.changeReason && 
                this.changeReason.length <= 50;
        },
      },

      async mounted() {
        try {
          await this.getrole()
          this.getOwnApplications()
          this.getteam()
          this.getTeamApplications()
        } catch (error) {
          console.error('Error during mounted execution', error)
        }
      },

      methods: {

        findId(id, arr) {
          for (let i = 0; i < arr.length; i++) {
            if (id == arr[i][0]) {
              return i;
            }
          }
          return 0;
        },

        async getrole() {
          try {
            const response = await fetch("https://spm-project-g9-t3-aql6.vercel.app/employee");
            const returnedJSON = await response.json();
            console.log(returnedJSON);

            this.dataArr = returnedJSON.data;

            const staffInd = this.findId(this.staffID, this.dataArr);

            this.role = this.dataArr[staffInd][8];

            console.log(this.role);
          } catch (error) {
            console.error("Error fetching data:", error);
            this.isLoading = false;
          }
        },


        async getteam() {
          const team = await axios.post('https://spm-project-g9-t3-aql6.vercel.app/findTeam/' + this.staffID)
          var teamResult = team.data.employees
          this.teamData = teamResult
          console.log(this.teamData)
          resLen = Object.keys(this.teamData).length
          if (resLen > 1) {
            this.totalNumberInTeam = resLen
          } else {
            for (const [key, value] of Object.entries(this.teamData)) {
              this.totalNumberInTeam = value.length
            }
          }
        },
        async getTeamApplications() {
          try {
            var response = await axios.post('http://localhost:5001/getTeamApplications', {
              staffID: this.staffID  // send staffID in the request body as JSON
            });


            if (response.data.status === 'success') {
              console.log(response.data.Applications);  // Log the actual pending applications
              // Optionally, store the result in a data property for further use
              // this.TeampendingApplications = response.data.pendingApplications;

              // Try to see if there is a need to clear the array first
              var apps = response.data.Applications
              for (entry of apps) {
                const staffID = entry[0]
                const staffInd = this.findId(staffID, this.dataArr)
                const startDate = entry[1]
                if (entry[7]) {
                  if (Number(entry[7]) in this.teamRecurringIDs) {
                    continue
                  }
                    var shownDate = entry[5] + ' to ' + entry[6] + ' (' + entry[8] + ')'
                    console.log(shownDate)
                    this.teamRecurringIDs[entry[7]] = true
                } else {
                  var shownDate = startDate
                }

                this.teamApplications[entry[3]].push({
                  Staff_ID: staffID,
                  Staff_Name: this.dataArr[staffInd][1] + ' ' + this.dataArr[staffInd][2],
                  Date_Applied: shownDate,
                  Time_Of_Day: entry[2],
                  Status_Of_Application: entry[3],
                  Reason: entry[4],
                  Withdraw_Reason: entry[10],
                  Decision: entry[9]
                })
                if (entry[3] == 'Approved') {
                  if (!this.tempApproveCount[startDate]) {
                    this.tempApproveCount[startDate] = {}
                  }

                  if (!this.tempApproveCount[startDate][staffID]) {
                    this.tempApproveCount[startDate][staffID] = 1
                  }

                  for (const [key, value] of Object.entries(this.tempApproveCount)) {
                    this.dateSortedApproved[key] = Object.keys(value).length
                  }
                  console.log(this.dateSortedApproved)
                }
              }
              this.appsCopy = this.teamApplications
              console.log(this.teamApplications)

            } else {
              console.error('Error:', response.data.message);
            }
          } catch (error) {
            console.error('API call failed:', error);
          }
        },

        getOwnApplications() {
          const today = new Date()
          this.staffID = localStorage.getItem('staffID');
          staffInd = this.findId(this.staffID, this.dataArr);

          fetch('https://spm-project-g9-t3-aql6.vercel.app/application')
            .then(response => response.json())
            .then(returnedJSON => {
              this.ApplicationArr = returnedJSON.data;
              console.log(this.ApplicationArr)

              for (entry of this.ApplicationArr) {
                if (entry[0] == this.staffID) {
                  const staffInd = this.findId(this.staffID, this.dataArr);

                  if (entry[4] == 'Approved') {
                    var withdrawable = true
                    appDate = new Date(`${entry[1]}`)
                    appDate.setHours(0,0,0,0)
                    // console.log(today-appDate)
                    if ((today-appDate) > 1296000000 || (today-appDate) < -1209600000) {
                      withdrawable = false
                    }
                  }

                  if (entry[10]) {
                  if (Number(entry[10]) in this.ownRecurringIDs) {
                    continue
                  }
                    var shownDate = entry[8] + ' to ' + entry[9] + ' (' + entry[11] + ')'
                    console.log(shownDate)
                    this.ownRecurringIDs[entry[10]] = true
                } else {
                  var shownDate = entry[1]
                }

                  this.ownApplications[entry[4]].push({
                    Staff_ID: this.staffID,
                    Staff_Name: this.dataArr[staffInd][1] + ' ' + this.dataArr[staffInd][2],
                    Date_Applied: shownDate,
                    Time_Of_Day: entry[2],
                    Status_Of_Application: entry[4],
                    Reason: entry[5],
                    Decision: entry[6],
                    withdrawable: withdrawable
                  })


                }

              }
            });
        },
        updateStats() {
          console.log('updating...')
          if (this.dateSortedApproved[this.selectedDate]) {
            this.totalWFH = this.dateSortedApproved[this.selectedDate]
            this.totalInOffice = this.totalNumberInTeam - this.totalWFH
            // this.percentageWFH = (this.totalWFH/this.totalInOffice).toFixed(2)
          } else {
            this.totalWFH = 0
            this.totalInOffice = this.totalNumberInTeam
          }
        },
        
        filterDates(type) {

          console.log('filtering...')
          if (type == 'all') {
            this.teamApplications = this.appsCopy
            this.filteredDate = ''
            return
          }
          this.teamApplications = { 'Approved': [], 'Pending': [], 'Rejected': [], 'Pending_Withdrawal': [] }
          for (var [key,value] of Object.entries(this.appsCopy)) {
            console.log(key,value)
            for (var app of value) {
              if (app.Date_Applied == this.filteredDate) {
              this.teamApplications[key].push(app)
            }
            }

          }
        },

        toggleView() {
          if (this.role == '2') {
            this.isManagerView = False
          }
          else {
            if (this.isManagerView) {
              this.fields.push({ key: "Change", label: "Change" })
            } else {
              this.fields.pop()
            }
            this.isManagerView = !this.isManagerView
          }
        },
        setTab(tab) {
          this.activeTab = tab;
        },
        goBack() {
          window.location.href = "../Home/home.html"
        },
        async approve(item) {
          // Use this to manage the approval of pending requests, prolly is sql here?
          try {
            if (this.tempApproveCount[item.Date_Applied]) {
              if (!(item.Staff_ID in this.tempApproveCount[item.Date_Applied])) {
                var percentWFH = (this.dateSortedApproved[item.Date_Applied] + 1) / this.totalNumberInTeam
                if (percentWFH > 0.5) {
                  alert("Quota exceeded")
                  return
                }
              }
            }
            console.log(item)
            console.log(item.Staff_ID, item.Date_Applied, item.Time_Of_Day)
            const response = await axios.post('https://spm-project-g9-t3-aql6.vercel.app/approveApplication', {
              Staff_ID: item.Staff_ID,
              Date_Applied: item.Date_Applied,
              Time_Of_Day: item.Time_Of_Day,
            });
            if (response.data.status === 'success') {
              // Remove the approved application from the pending list
              this.teamApplications['Pending'] = this.teamApplications['Pending'].filter(
                app => !(app.Staff_ID === item.Staff_ID && app.Date_Applied === item.Date_Applied && app.Time_Of_Day === item.Time_Of_Day)
              );
              // Optionally, add it to the approved applications list
              this.teamApplications['Approved'].push({
                ...item,
                Status_Of_Application: 'Approved',
                Decision: 'No Issue'
              });
            } else {
              console.error('Error:', response.data.message);
              alert('Failed to approve application: ' + response.data.message);
            }
          } catch (error) {
            console.error('API call failed:', error);
            alert('An error occurred while approving the application.');
          }

        },
        openRejectionModal(item) {
          this.showRejectionModal = true;  // If manager reject, this leads to the pop out
          this.selectedItem = item;
        },
        closeRejectionModal() {
          this.showRejectionModal = false;
          this.rejectionReason = '';
          // Set it back to default
          this.selectedItem = null;
        },
        async submitRejection() {
          // Logic for submitting rejection reason -> this one will manage the rejection of pending requests, prolly is sql here also?
          try {
            const response = await axios.post('https://spm-project-g9-t3-aql6.vercel.app/rejectApplication', {
              Staff_ID: this.selectedItem.Staff_ID,
              Date_Applied: this.selectedItem.Date_Applied,
              Time_Of_Day: this.selectedItem.Time_Of_Day,
              Rejection_Reason: this.rejectionReason,
            });
            if (response.data.status === 'success') {
              // Remove the rejected application from the pending list
              this.teamApplications['Pending'] = this.teamApplications['Pending'].filter(
                app => !(app.Staff_ID === this.selectedItem.Staff_ID && app.Date_Applied === this.selectedItem.Date_Applied && app.Time_Of_Day === this.selectedItem.Time_Of_Day)
              );
              // Add it to the rejected applications list
              this.teamApplications['Rejected'].push({
                ...this.selectedItem,
                Status_Of_Application: 'Rejected',
                Decision: this.rejectionReason, // Set the rejection reason
              });
              // Close the modal
              alert('Application successfully rejected!')
              this.closeRejectionModal();
            } else {
              console.error('Error:', response.data.message);
              alert('Failed to reject application: ' + response.data.message);
            }
          } catch (error) {
            console.error('API call failed:', error);
            alert('An error occurred while rejecting the application.');
          }
          this.closeRejectionModal();
        },

        findstaffid(item) {
          fetch('https://spm-project-g9-t3-aql6.vercel.app/employee')
            .then(response => response.json())
            .then(returnedJSON => {
              dataArr = returnedJSON.data;
              staffInd = this.findId(firstname, dataArr);
            })
            .catch(error => console.error('Error fetching data:', error));
        },

        openWithdrawalModal(application) {
          this.selectedItem = application
          this.withdrawalReason = ''
          $('#withdrawalModal').modal('show')
        },

        withdraw(item) {
          console.log(item)
          if (item.Status_Of_Application === 'Pending') {
            // Handle withdrawal directly for pending applications
            this.withdrawPendingApplication(item);
          } else if (item.Status_Of_Application === 'Approved' || item.Status_Of_Application==='Pending_Withdrawal') {
            // Open the modal for approved applications
            this.selectedItem = item; // Store the selected application
            this.withdrawalReason = ''; // Reset any previous reason
            this.showWithdrawalModal = true; // Show the modal
          }
        },

        async withdrawPendingApplication(item) {
          console.log(item)
          try {
            const response = await axios.post('https://spm-project-g9-t3-aql6.vercel.app/withdrawPendingApplication', {
              Staff_ID: item.Staff_ID,
              Date_Applied: item.Date_Applied,
              Time_Of_Day: item.Time_Of_Day,
              Reason: item.Reason,
              Status: item.Status_Of_Application
            });
            console.log(response);
            if (response.data.status === 'success') {
              this.ownApplications['Pending'] = this.ownApplications['Pending'].filter(
                app =>
                  !(
                    app.Staff_ID === item.Staff_ID &&
                    app.Date_Applied === item.Date_Applied &&
                    app.Time_Of_Day === item.Time_Of_Day
                  )
              );
              alert('Application withdrawn successfully.');
            } else {
              alert('Failed to withdraw the application.');
            }
          } catch (error) {
            console.error('Error during withdrawal:', error);
            alert('An error occurred while trying to withdraw the application.');
          }
        },

        async submitWithdrawal() {
          if (!this.withdrawalReason) {
            alert('Please provide a reason for withdrawal.');
            return;
          }

          try {
            const response = await axios.post('https://spm-project-g9-t3-aql6.vercel.app/withdrawApprovedApplication', {
              Staff_ID: this.selectedItem.Staff_ID,
              Date_Applied: this.selectedItem.Date_Applied,
              Time_Of_Day: this.selectedItem.Time_Of_Day,
              Withdraw_Reason: this.withdrawalReason
            });
            console.log(response);
            if (response.data.status === 'success') {
              this.teamApplications['Approved'] = this.teamApplications['Approved'].filter(
                app =>
                  !(
                    app.Staff_ID === this.selectedItem.Staff_ID &&
                    app.Date_Applied === this.selectedItem.Date_Applied &&
                    app.Time_Of_Day === this.selectedItem.Time_Of_Day
                  )
              );
              alert('Application withdrawn successfully.');
              this.closeWithdrawalModal();
            } else {
              alert('Failed to withdraw the application.');
            }
          } catch (error) {
            console.error('Error during withdrawal:', error);
            alert('An error occurred while trying to withdraw the application.');
          }
        },


        async pendingsubmitWithdrawal() {
          if (!this.withdrawalReason) {
            alert('Please provide a reason for withdrawal.');
            return;
          }

          try {
            const response = await axios.post('https://spm-project-g9-t3-aql6.vercel.app/pendingwithdrawApprovedApplication', {
              Staff_ID: this.selectedItem.Staff_ID,
              Date_Applied: this.selectedItem.Date_Applied,
              Time_Of_Day: this.selectedItem.Time_Of_Day,
              Withdraw_Reason: this.withdrawalReason
            });
            console.log(response);
            if (response.data.status === 'success') {
              this.ownApplications['Approved'] = this.ownApplications['Approved'].filter(
                app =>
                  !(
                    app.Staff_ID === this.selectedItem.Staff_ID &&
                    app.Date_Applied === this.selectedItem.Date_Applied &&
                    app.Time_Of_Day === this.selectedItem.Time_Of_Day
                  )
              );
              alert('Pending Application withdrawal submitted.');
              this.closeWithdrawalModal();
            } else {
              alert('Failed to withdraw the application.');
            }
          } catch (error) {
            console.error('Error during withdrawal:', error);
            alert('An error occurred while trying to withdraw the application.');
          }
        },


        async RejectPendingSubmitWithdrawal() {
          if (!this.rejectionReason) {
            alert('Please provide a reason for withdrawal.');
            return;
          }

          try {
            console.log(this.selectedItem)
            const response = await axios.post('https://spm-project-g9-t3-aql6.vercel.app/RejectPendingWithdrawApprovedApplication', {
              Staff_ID: this.selectedItem.Staff_ID,
              Date_Applied: this.selectedItem.Date_Applied,
              Time_Of_Day: this.selectedItem.Time_Of_Day,
              Withdrawal_Reason: this.rejectionReason
            });
            console.log(response);
            if (response.data.status === 'success') {
              this.teamApplications['Pending_Withdrawal'] = this.teamApplications['Pending_Withdrawal'].filter(
                app =>
                  !(
                    app.Staff_ID === this.selectedItem.Staff_ID &&
                    app.Date_Applied === this.selectedItem.Date_Applied &&
                    app.Time_Of_Day === this.selectedItem.Time_Of_Day
                  )

                  
              );
                // Add it to the rejected applications list
                this.teamApplications['Approved'].push({
                  ...this.selectedItem,
                  Status_Of_Application: 'Approved',
                  Decision: this.rejectionReason, // Set the rejection reason
                });

              alert('Withdrawn application rejected.');
              this.closeRejectionModal();
            } else {
              alert('Failed to reject the application.');
            }
          } catch (error) {
            console.error('Error during withdrawal:', error);
            alert('An error occurred while trying to reject the application.');
          }
        },

        async ApprovePendingSubmitWithdrawal(item) {
          try {
            console.log(item)
            const response = await axios.post('https://spm-project-g9-t3-aql6.vercel.app/ApprovePendingWithdrawApprovedApplication', {
              Staff_ID: item.Staff_ID,
              Date_Applied: item.Date_Applied,
              Time_Of_Day: item.Time_Of_Day,
            });
            console.log(response);
            if (response.data.status === 'success') {
              this.teamApplications['Pending_Withdrawal'] = this.teamApplications['Pending_Withdrawal'].filter(
                app =>
                  !(
                    app.Staff_ID === item.Staff_ID &&
                    app.Date_Applied === item.Date_Applied &&
                    app.Time_Of_Day === item.Time_Of_Day
                  )

                  
              )
              alert('Application withdrawn approved.');
              this.closeRejectionModal();
            } else {
              alert('Failed to approve the application.');
            }
          } catch (error) {
            console.error('Error during withdrawal:', error);
            alert('An error occurred while trying to approve the application.');
          }
        },
        
        closeWithdrawalModal() {
          this.showWithdrawalModal = false;
          this.selectedItem = null;
          this.withdrawalReason = '';
        },

      openChangeModal(item) {
          this.selectedItem = item;
          this.showChangeModal = true;
          this.changeDate = '';
          this.changeReason = '';
          this.fixedDateOptions = {};
        },
        closeChangeModal() { 
          this.showChangeModal = false;
          this.resetChangeForm();
        },
        resetChangeForm() {
          this.changeDate = '';
          this.changeReason = '';
          this.fixedDateOptions = {};
        },
        getDayName(value) { 
          const day = this.daysOfWeek.find(d => d.value === value);
          return day ? day.text : '';
        },

        generateDateArray() { 
          if (this.startDate && this.endDate) {
            this.fixedDateArray = [];
            let currentDate = new Date(this.startDate);
            const endDate = new Date(this.endDate);
            
            while (currentDate <= endDate) {
              // Only include weekdays (Monday-Friday)
              if (currentDate.getDay() !== 0 && currentDate.getDay() !== 6) {
                const dateStr = currentDate.toISOString().split('T')[0];
                this.fixedDateArray.push(dateStr);
                
                // Initialize time option if not already set
                if (!this.fixedDateOptions[dateStr]) {
                  this.fixedDateOptions[dateStr] = 'FULL';
                }
              }
              currentDate.setDate(currentDate.getDate() + 1);
            }
          }
        },

        formatDate(dateStr) {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        },
        async submitChange() {
          try {
            const response = await axios.post('https://spm-project-g9-t3-aql6.vercel.app/changeApplication', {
              Staff_ID: this.selectedItem.Staff_ID,
              Date_Applied: this.selectedItem.Date_Applied,
              Time_Of_Day: this.selectedItem.Time_Of_Day,
              changeDate: this.changeDate,
              changeTimeOfDay: this.selectedItem.Time_Of_Day, 
              changeReason: this.changeReason
            });
            
            if (response.data.status === 'success') {
              this.ownApplications['Approved'] = this.ownApplications['Approved'].filter(
                app => !(
                  app.Staff_ID === this.selectedItem.Staff_ID &&
                  app.Date_Applied === this.selectedItem.Date_Applied &&
                  app.Time_Of_Day === this.selectedItem.Time_Of_Day
                )
              );
              alert('Application change submitted successfully!');
              this.closeChangeModal();
            } else {
              alert('Failed to submit application change: ' + response.data.message);
            }
          } catch (error) {
            console.error('Error submitting change:', error);
            alert('Failed to submit application change.');
          }
        },
        // END OF METHODS HERE! for reference
      },

      

    });
  </script>
</body>

</html>