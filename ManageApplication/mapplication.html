<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage My WFH Applications</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.21.2/dist/bootstrap-vue.min.css"
      rel="stylesheet"
    />
    <link href="mapplication.css" rel="stylesheet" />
  </head>
  <body>
    <div id="app" class="container mt-5">
      <div class="form-container">
        <h2 class="text-center mb-4">Manage My WFH Applications</h2>

        <!-- Tabs for Approved, Pending, and Rejected Applications -->
        <b-nav tabs class="mb-4">
          <b-nav-item
            :active="activeTab === 'approved'"
            @click="setTab('approved')"
            class="nav-item"
            >Approved Applications</b-nav-item
          >
          <b-nav-item
            :active="activeTab === 'pending'"
            @click="setTab('pending')"
            class="nav-item"
            >Pending Applications</b-nav-item
          >
          <b-nav-item
            :active="activeTab === 'rejected'"
            @click="setTab('rejected')"
            class="nav-item"
            >Rejected Applications</b-nav-item
          >
        </b-nav>

        <!-- Applications Table for Each Tab -->
        <b-card v-if="activeTab === 'approved'" class="card mb-4">
          <b-card-header>Approved Applications</b-card-header>
          <b-card-body>
            <b-table
              :items="approvedApplications"
              :fields="fields"
              responsive="sm"
            ></b-table>
          </b-card-body>
        </b-card>

        <b-card v-if="activeTab === 'pending'" class="card mb-4">
          <b-card-header>Pending Applications</b-card-header>
          <b-card-body>
            <b-table
              :items="pendingApplications"
              :fields="fields"
              responsive="sm"
            ></b-table>
          </b-card-body>
        </b-card>

        <b-card v-if="activeTab === 'rejected'" class="card mb-4">
          <b-card-header>Rejected Applications</b-card-header>
          <b-card-body>
            <b-table
              :items="rejectedApplications"
              :fields="fields"
              responsive="sm"
            ></b-table>
          </b-card-body>
        </b-card>

        <!-- Back to Home Page Button -->
        <div class="text-center mt-4">
          <b-button variant="primary" class="btn-primary" @click="goBack"
            >Go Back to Home Page</b-button
          >
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.21.2/dist/bootstrap-vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      new Vue({
        el: "#app",
        data: {
          activeTab: "approved",
          // Data variables for applications
          approvedApplications: [],
          pendingApplications: [],  // Now correctly referenced
          rejectedApplications: [],
          fields: [
            { key: "Staff_ID", label: "Staff ID" },
            { key: "Date_Applied", label: "Date Applied" },
            { key: "Time_Of_Day", label: "Time of Day" },
            { key: "Status_Of_Application", label: "Status" },
            { key: "Reason", label: "Reason" },
          ],
          staffID: localStorage.getItem("staffID"), // Fetch staffID from localStorage
        },
        methods: {
          async fetchPendingRequests() {
            try {
              const response = await axios.post(
                "http://localhost:5001/getPendingApplications",
                {
                  staffID: this.staffID, // Pass staffID to the backend
                }
              );
    
              if (response.data.status === "success") {
                const rawData = response.data.pendingApplications;
    
                // Handle zero or multiple requests
                if (rawData.length === 0) {
                  console.log("No pending applications found.");
                  this.pendingApplications = [];
                } else {
                  console.log("Pending Applications:", rawData);
    
                  // Assuming the structure is a list of arrays, where each array contains the values for one row
                  this.pendingApplications = rawData.map(application => {
                    return {
                      Staff_ID: application[0],         // First item as Staff ID
                      Date_Applied: application[1],     // Second item as Date Applied
                      Time_Of_Day: application[2],      // Third item as Time of Day
                      Status_Of_Application: application[3], // Fourth item as Status
                      Reason: application[4],           // Fifth item as Reason
                    };
                  });
    
                  console.log("Transformed Pending Applications:", this.pendingApplications);
                }
              } else {
                console.error(response.data.message);
              }
            } catch (error) {
              console.error("Error fetching pending requests:", error);
            }
          },
          setTab(tab) {
            this.activeTab = tab;
            if (tab === "pending") {
              this.fetchPendingRequests();  // Fetch pending requests when "Pending" tab is selected
            }
          },
          goBack() {
            window.location.href = "../Home/home.html";
          },
        },
        mounted() {
          // Fetch the pending requests when the component is mounted
          this.fetchPendingRequests();
        },
      });
    </script>
    
  </body>
</html>
